# AIDriver

Назначение
----------

AIDriver реализует полноценного бота-водителя для машины на трассе. Скрипт использует CarController как исполнитель ввода, Rigidbody для физики и LapTracker для респавна. В качестве источника геометрии трассы он предпочитает TrackRibbon, а при его отсутствии переходит к езде по чекпоинтам RaceTrack.

Зависимости и инициализация
---------------------------

- RequireComponent(CarController) и RequireComponent(Rigidbody) гарантируют наличие нужных компонентов.
- В Awake кешируются ссылки на CarController, Rigidbody и LapTracker.
- В Start, если поля track и ribbon не заданы вручную, скрипт находит RaceTrack и TrackRibbon в сцене.
- Если найдена лента ribbon, бот сразу переякоривается к ближайшей точке трассы (RebindToRibbon) и передаёт управление вводу машине через car.SetInputProvider(this).

Движение по ленте TrackRibbon
-----------------------------

В режиме useRibbon основной цикл FixedUpdate вызывает FollowRibbon:

- Переменная s — дуговая длина вдоль ленты; она накапливается пропорционально текущей скорости и оборачивается по длине трассы.
- Через ribbon.Evaluate(s, lateral) вычисляются координаты центральной линии, а также позиции у левого и правого краёв, из которых определяется halfWidth.
- По оценке SignedCurvature рассчитывается кривизна участка, которая влияет на целевую скорость и смещение к внутренней стороне поворота (insideBias).
- laneOffsetTarget задаёт желаемую “полосу” на дороге; бот постепенно возвращается к центру, но может смещаться для обгона или ухода от стен.

Распознавание стен и трафика
----------------------------

Группа полей Edge Safety / Walls описывает боковые и диагональные лучи для обнаружения стен (wallMask). На основе результатов WallAvoidBias бот:

- добавляет поправку к laneOffsetTarget (wallRepel) для уезда от близкой стены;
- увеличивает steering на основе steerAvoidGain, чтобы машина активнее отворачивала от препятствия.

Для других машин используются сферические лучи вперёд (vehicleMask, sensorLength, sensorRadius). При слишком малом зазоре EmergencyFrontVehicleLimit ограничивает целевую скорость, чтобы избежать столкновения. Подробности о переднем сенсоре см. в [документации Physics.SphereCast](https://docs.unity3d.com/ScriptReference/Physics.SphereCast.html).

Обгон и выбор полосы
--------------------

Логика обгона сосредоточена в PlanOvertakeSide и связанных полях:

- passMaxCurvature — обгон возможен только на прямых и пологих участках с невысокой кривизной.
- passMinGap — расстояние до лидера, при котором инициируется попытка обгона.
- passOffset и passHoldTime задают величину и длительность смещения в сторону; после завершения манёвра включается passCooldown, запрещающий мгновенные повторные обгоны.
- personaLaneBias и другие случайно генерируемые параметры создают разные “характеры” ботов: кто-то чаще лезет вправо, кто-то — влево.

Контроль скорости
-----------------

Целевая скорость складывается из нескольких ограничений:

- vCurve — лимит по кривизне трассы (curvatureToSlowdown), уменьшающий скорость в поворотах.
- vWall — ограничение по ближайшей стене вперёд по направлению машины и по направлению цели.
- vEmerg — аварийное ограничение по трафику (EmergencyFrontVehicleLimit).

После выбора targetSpeed используется простое PD-регулирование (SpeedPD) с коэффициентами kp и kd, формирующее “желательное ускорение”, которое конвертируется в Throttle и Brake.

Защита от неправильного направления
-----------------------------------

Группа полей Wrong-way guard контролирует борьбу с езной в обратную сторону при движении по ленте:

- wrongWayDotThreshold задаёт порог dot между forward машины и тангенсом ленты; ниже порога считается, что машина смотрит назад.
- wrongWayClampSpeed ограничивает максимальную разрешённую скорость при ошибочном направлении.
- wrongWaySteerBoost добавляет к рулю поворот в сторону выравнивания с направлением трассы.
- WrongWayGuard накапливает wrongWayTimer и при его превышении вызывает респавн через LapTracker.

Стабилизация, застревание и авто-респавн
----------------------------------------

Дополнительные подсистемы:

- StabilityAssist следит за наклоном кузова, создаёт выпрямляющий момент и при сильном перевороте с малой скоростью респавнит машину (flipRespawnAngle, flipRespawnDelay).
- HandleUnstuck обнаруживает длительное медленное движение (stuckSpeed, stuckTime) и переводит машину в режим reverse, а при безуспешной попытке сдачи назад вызывает респавн.
- AutoPopIfNoMove отслеживает почти полное отсутствие движения (noMoveSpeed, noMoveTime) и делает аккуратные “нуджи” вперёд или в сторону, пробуя несколько безопасных позиций, прежде чем принудительно респавнить машину.
- Race Start Gate блокирует все эти автоматические вмешательства до старта гонки (waitForGreen, greenMinSpeed, greenMinMoveTime), чтобы машина не пыталась “вылезти” раньше зелёного сигнала.