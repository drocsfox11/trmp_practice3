LapTracker — компонент, который закрепляется за каждой машиной и следит за её прогрессом по трассе. При инициализации через метод Init трекер получает ссылку на RaceManager и количество чекпоинтов. Он вычисляет, какой индекс будет считаться следующим ожидаемым чекпоинтом, устанавливает текущий круг равным единице, обнуляет накопленный список времён кругов и определяет, является ли данный объект игроком или ботом, проверяя тег Player на себе и на корневом объекте. Если в RaceManager задана корректная трасса и есть хотя бы один чекпоинт, LapTracker сразу же запоминает первую точку как исходную позицию респавна и вычисляет направление сегмента от неё к следующему чекпоинту. В противном случае трекер подстраховывается, используя собственную позицию и направление объекта как базовую точку возврата.

Как только гонка стартует, RaceManager вызывает StartRacing для всех участников. В этом методе LapTracker включает режим racing, фиксирует время начала круга и, если трекер относится к машине игрока, обновляет HUD, показывая номер текущего круга и общее количество кругов в заезде. Далее вся логика строится вокруг события OnCheckpointTriggered, которое вызывается чекпоинтом при пересечении триггера. Сначала трекер проверяет, активен ли сейчас режим гонки, затем сравнивает индекс пришедшего чекпоинта с ожидаемым nextIndex. Если индекс не совпадает, событие игнорируется, что защищает систему от “срезов” трассы и случайных пересечений соседних чекпоинтов в неверном порядке.

Основные обязанности LapTracker можно кратко описать так:

- отслеживать последовательность чекпоинтов и обеспечивать, чтобы каждый новый круг считался завершённым только при честном прохождении полной петли, обновляя при этом список времён кругов, состояние HUD игрока и позиции безопасного респавна, а по достижении нужного количества кругов сообщать RaceManager о финише конкретной машины.

Когда индекс чекпоинта равен нулю, LapTracker считает, что машина завершила круг. В этот момент вычисляется время круга как разница между текущим временем и значением lapStartTime, результат добавляется в коллекцию lapTimes и передаётся менеджеру гонки через OnLapCompleted вместе с номером круга. Затем счётчик currentLap увеличивается, и если новое значение превышает общее количество кругов, трекер выключает режим racing и сообщает RaceManager о финише машины, передавая полный список времён кругов в OnCarFinished. Если кругов ещё осталось, LapTracker переносит lapStartTime на текущее время, снова, при необходимости, обновляет HUD и переходит к ожиданию следующего чекпоинта.

Роль методов RespawnToLastCheckpoint и GetSegmentDir особенно важна для других систем. Первый аккуратно переносит машину к сохранённому чекпоинту: временно включает режим isKinematic у Rigidbody, обнуляет линейную и угловую скорость, задаёт позицию немного выше поверхности и ориентирует объект так, чтобы он смотрел в сторону заранее вычисленного LastForward, после чего возвращает физику в активное состояние. Второй метод помогает WrongWayEnforcer и другим защитным компонентам понять, куда именно “смотрит” трасса в окрестности текущего сегмента, проецируя отрезок между двумя соседними чекпоинтами на горизонтальную плоскость и нормализуя направление. Благодаря этому LapTracker выступает общей точкой синхронизации для HUD, систем респавна и всей логики контроля направления движения.
